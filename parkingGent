{
    "name": "parkingGent",
    "version": "1.0.7",
    "type": "sensor",
    "script": "//array of parkings that are full from the previous check\nvar cacheFullParkings = waylayUtil.getCacheData(options, \"fullParkings\") || [];\nvar cacheLowCapacityParkings= waylayUtil.getCacheData(options, \"lowCapacityParkings\") || [];\n\nvar url =\"http://datatank.gent.be/Mobiliteitsbedrijf/Parkings11.json\";\nvar recommendations = [];\nvar fullParkings, listAvailiableParkings, listLowCapacityParkings, listFullParkings, listRemainFullParkings, listBackToAvailableParkings;\nrequest({\n        \"uri\": url\n    }, function(err, response, body){\n        if (!err && response.statusCode == 200) {\n            var data = JSON.parse(body);\n            //console.log(data);\n            processData(data);\n        } else {\n            console.log(response);\n            send(new Error(response.statusCode));\n        }\n});\n\nvar filterParking = function(parking){\n    var flag = ( __.contains(listAvailiableParkings, parking)  &&  (!__.contains(cacheFullParkings, parking) && !__.contains(cacheLowCapacityParkings, parking)) ) || \n               ( __.contains(listAvailiableParkings, parking)  &&  (__.contains(cacheFullParkings, parking) || __.contains(cacheLowCapacityParkings, parking) ) && \n                        !__.contains(listLowCapacityParkings, parking));\n    console.log(\"checking for \"+parking + \" is \" + flag);\n    return flag ;\n    \n}\n\nvar processData = function(data){\n    var parkings = data.Parkings11.parkings;\n    parkings = __.map(parkings, function(p) {\n        p.availCapPercentage = parseFloat(p.availableCapacity)/parseFloat(p.totalCapacity);\n        return p;\n    });\n    var availableParkings = __.filter(parkings, function(parking) {\n        return (!parking.full && parking.open && parking.availableCapacity !=\"VOL\" );\n    });\n    \n    fullParkings = __.filter(parkings, function(parking) {return parking.full || parking.availableCapacity ==\"VOL\" || !parking.open;});\n        \n    listAvailiableParkings = __.map(availableParkings, function(p) {return p.description});\n    listLowCapacityParkings = __.compact(__.map(availableParkings, function(p) {if(p.availCapPercentage < 0.15) return p.description}));\n    listFullParkings = __.map(fullParkings, function(p) {return p.description});\n    listRemainFullParkings = __.compact(__.map(listFullParkings, function(p) {\n        if(__.contains(cacheFullParkings, p.description) ) return p.description}));\n    listBackToAvailableParkings = __.union(__.compact(__.map(availableParkings, function(p) {\n        if(p.availCapPercentage > 0.15 && __.contains(cacheFullParkings, p.description) ) return p.description})), \n        __.compact(__.map(availableParkings, function(p) {\n        if(p.availCapPercentage > 0.15 && __.contains(cacheLowCapacityParkings, p.description) ) return p.description}))\n        );\n    listAlterntativeToAvailableParkings = __.union(listBackToAvailableParkings, \n        __.compact(__.map(availableParkings, function(p) {\n        if(p.availCapPercentage > 0.15 && !__.contains(cacheLowCapacityParkings, p.description) && \n        !__.contains(cacheFullParkings, p.description)) return p.description}))\n        );\n    \n    var state = \"OK\";\n    if(fullParkings.length > 0 && fullParkings.length <3)\n      state = \"MEDIUM\";\n    else if(fullParkings.length > 2)\n       state = \"CRITICAL\";\n    var rawData = { \n        fullParkings : listFullParkings, \n        availableParkings: listAvailiableParkings,\n        lowCapacityParkings: listLowCapacityParkings,\n        backToAvailableParkings : listBackToAvailableParkings,\n        remainFullParkings: listRemainFullParkings,\n        alterntativeAvailableParkings: listAlterntativeToAvailableParkings,\n        parkings: parkings\n    };\n    var value ={\n        observedState : state,\n        rawData : rawData\n    }\n   send(null, value);\n};\n\n\n//processData(response);\n\n/*\nvar response = { \"Parkings11\" : {\n  \"parkings\": [\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P01\",\n      \"description\": \"Vrijdagmarkt\",\n      \"address\": \"Vrijdagmarkt 1,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 00 <br> (permanentie)<br> Tel.: 09 266 29 01 <br> (tijdens kantooruren)\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 642,\n      \"availableCapacity\": \"68\",\n      \"latitude\": 51.057,\n      \"longitude\": 3.726,\n      \"covered\": true\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P07\",\n      \"description\": \"Sint-Michiels\",\n      \"address\": \"Sint-Michielsplein 8,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 20\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 450,\n      \"availableCapacity\": \"140\",\n      \"latitude\": 51.053,\n      \"longitude\": 3.719,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P10\",\n      \"description\": \"Sint-Pietersplein\",\n      \"address\": \"Sint-Pietersplein 65,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 60\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 708,\n      \"availableCapacity\": \"377\",\n      \"latitude\": 51.042,\n      \"longitude\": 3.726,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P04\",\n      \"description\": \"Savaanstraat\",\n      \"address\": \"Savaanstraat 13,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 40\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 540,\n      \"availableCapacity\": \"257\",\n      \"latitude\": 51.0486,\n      \"longitude\": 3.7222,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P02\",\n      \"description\": \"Reep\",\n      \"address\": \"Seminariestraat 9,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 50\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 470,\n      \"availableCapacity\": \"66\",\n      \"latitude\": 51.052,\n      \"longitude\": 3.731,\n      \"covered\": true,\n      \"activeRoute\": []\n    },\n    {\n      \"timestamp\": 1430400059757,\n      \"name\": \"P08\",\n      \"description\": \"Ramen\",\n      \"address\": \"Ramen 23,<br>9000 Gent\",\n      \"contactInfo\": \"Tel.: 09 266 29 70\",\n      \"openingHours\": \"24/24 open\",\n      \"open\": true,\n      \"full\": false,\n      \"suggestedRGB\": \"#00ff00\",\n      \"totalCapacity\": 266,\n      \"availableCapacity\": \"85\",\n      \"latitude\": 51.056,\n      \"longitude\": 3.716,\n      \"covered\": true,\n      \"activeRoute\": []\n    }\n  ]\n}};\n*/",
    "metadata": {
        "author": "",
        "category": "Smart City",
        "description": "Parking fo sity Gent. If more than 3 parkings are full it returns CRITCAL state, and if\nthere are no full parkings it returns OK.\n\nIt returns as a raw data:\n<ul>\n<li>parkings, list of all parkings as an object</li>, \n<li>fullParkings, list of full parkings</li>, \n<li>availableParkings: list of availiable parkings</li>\n<li>lowCapacityParkings, list of parkings below 15%</li>\n<li>backToAvailableParkings, list of parkigs that are again free and above 15%</li>\n<li>remainFullParkings, list of parkigs that were full and are still full</li>\n<li>alterntativeAvailableParkings, list of parkings which are available and were not full or with low capacity before</li>\n</ul>\n",
        "documentationURL": "http://datatank.gent.be/Mobiliteitsbedrijf/Parkings11.jso",
        "iconURL": "https://raw.githubusercontent.com/waylayio/documentation/master/icons/parking.png",
        "supportedStates": [
            "OK",
            "MEDIUM",
            "CRITICAL"
        ],
        "requiredProperties": [],
        "requiredRawData": [],
        "rawData": [
            {
                "parameter": "parkings",
                "dataType": "Object[]"
            },
            {
                "parameter": "fullParkings",
                "dataType": "String[]"
            },
            {
                "parameter": "availableParkings",
                "dataType": "String[]"
            },
            {
                "parameter": "lowCapacityParkings",
                "dataType": "String[]"
            },
            {
                "parameter": "backToAvailableParkings",
                "dataType": "String[]"
            },
            {
                "parameter": "remainFullParkings",
                "dataType": "String[]"
            },
            {
                "parameter": "alterntativeAvailableParkings",
                "dataType": "String[]"
            }
        ]
    }
}
